<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Parent Window (Target)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f0f2f5; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        
        .step-box { border: 1px solid #ccc; padding: 15px; margin: 15px 0; border-radius: 4px; background: #fafafa; }
        .step-title { font-weight: bold; color: #555; margin-bottom: 10px; display: block; text-transform: uppercase; font-size: 0.85em; }
        
        button { cursor: pointer; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 14px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .log-display { background: #222; color: #0f0; font-family: monospace; padding: 10px; border-radius: 4px; margin-top: 10px; min-height: 40px; white-space: pre-wrap; }
        .log-intercept { color: #ff4444; } 
        
        iframe { width: 100%; height: 500px; border: 2px solid #333; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Parent Window (Target)</h2>
    <div><strong>Origin:</strong> <script>document.write(window.origin)</script></div>

    <div class="step-box">
        <span class="step-title">Step 1: Setup Local Parent Override</span>
        <p>Override <code>window.postMessage</code> locally on the Parent.</p>
        <button id="btnOverride" onclick="applyOverride()">Apply Override</button>
        <div id="statusOverride" style="margin-top: 5px; font-style: italic; color: #666;">Status: Native Implementation</div>
    </div>

    <div class="step-box">
        <span class="step-title">Step 2: Monitor Traffic</span>
        <p>Waiting for the Child Frame to attempt its attack and send a message.</p>
        <div id="logCross" class="log-display">Waiting for incoming message...</div>
    </div>

    <iframe src="https://kevin-braunstein.github.io/postmessagecrossoriginchild/"></iframe>
</div>

<script>
    const logCross = document.getElementById('logCross');
    const btnOverride = document.getElementById('btnOverride');

    function applyOverride() {
        try {
            window.__defineGetter__("postMessage", function() {
                return function(msg, target) {
                    // Local intercept logic
                    if (target === "*") { 
                         // Cross-origin attempt (if it worked)
                        logCross.innerHTML = "<span class='log-intercept'>[INTERCEPTED] Parent's local override caught the incoming message!</span>";
                    } else {
                         // Local test
                        console.log("Local override check");
                    }
                }
            });

            document.getElementById('statusOverride').innerHTML = "Status: <b>Overridden (Intercept Active)</b>";
            document.getElementById('statusOverride').style.color = "#d9534f";
            btnOverride.disabled = true;
        } catch (e) {
            alert("Error: " + e.message);
        }
    }

    // REAL EVENT LISTENER
    window.addEventListener("message", (event) => {
        logCross.innerHTML = `[SUCCESS] Message Received: "${event.data}"\n` +
                             `Origin: ${event.origin}\n` +
                             `Analysis: The browser BLOCKED the Child's attempt to 'drop' the message. The Parent received it safely.`;
    });
</script>

</body>
</html>
