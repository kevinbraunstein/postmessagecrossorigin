<!DOCTYPE html>
<html>
<head>
    <title>Parent Window</title>
    <style>
        body { font-family: sans-serif; background: #f0f0f0; padding: 20px; }
        .log { background: #fff; border: 1px solid #ccc; padding: 10px; margin-top: 10px; white-space: pre-wrap; }
        .hacked { color: red; font-weight: bold; }
        .secure { color: green; font-weight: bold; }
    </style>
</head>
<body>
    <h2>Parent Window</h2>
    <div id="status" class="log">Waiting for logs...</div>

    <iframe id="childFrame" src="https://kevin-braunstein.github.io/postmessagecrossoriginchild/" width="500" height="300"></iframe>

    <script>
        const logBox = document.getElementById('status');
        function log(msg, type) {
            const span = document.createElement('div');
            span.innerHTML = msg;
            if(type) span.className = type;
            logBox.appendChild(span);
        }

        // --- STEP 1: Override postMessage on Parent ---
        // We use __defineGetter__ as requested to simulate the legacy/hack attempt
        try {
            window.__defineGetter__("postMessage", function() {
                return function() {
                    console.log("PARENT INTERCEPT: Someone tried to postMessage to me!");
                    alert("PARENT HACKED: postMessage was intercepted on the Parent!");
                }
            });
            log("1. Parent local override active. (window.postMessage is now hacked)", "hacked");
        } catch (e) {
            log("Failed to override: " + e.message);
        }

        // --- STEP 2: Listen for messages from Child ---
        window.addEventListener("message", (event) => {
            log(`4. Parent received message: "${event.data}"`, "secure");
            log("   (If you see this, the Parent's override was BYPASSED by the browser)", "secure");
        });

        // --- STEP 3: Send message to Child (Cross-Origin) ---
        const iframe = document.getElementById('childFrame');
        iframe.onload = function() {
            log("2. Sending message to Child Iframe...", "secure");
            // If the Child's override worked cross-origin, this would fail or alert.
            // If the browser enforces security, this sends normally.
            iframe.contentWindow.postMessage("Hello from Parent", "*");
        };
    </script>
</body>
</html>
